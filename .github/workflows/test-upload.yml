name: Task A with Artifact Handling and Compression

on:
  push:
    branches: [ test ]
  workflow_dispatch:

jobs:
  task_a:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Check for artifact from previous run
      id: check_artifact
      uses: actions/download-artifact@v3
      continue-on-error: true
      with:
        name: nx-cache-compressed
        path: .

    - name: Decompress artifact if exists
      if: steps.check_artifact.outcome == 'success'
      run: |
        if [ -f "nx-cache.tar.gz" ]; then
          tar -xzf nx-cache.tar.gz
          rm nx-cache.tar.gz
        fi

    - name: Run Task A
      id: task_a
      run: |
        if [ -d ".nx" ] && [ "$(ls -A .nx)" ]; then
          echo "Using data from previous run"
          echo "Previous run data:" >> .nx/output.txt
          cat .nx/output.txt
        else
          echo "Running Task A from scratch"
          mkdir -p .nx
          echo "Initial run data" > .nx/output.txt
        fi
        
        # Add a timestamp to the output file
        echo "Run at: $(date)" >> .nx/output.txt
        
        # Always fail the task
        echo "Task A is failing intentionally"
        exit 1

    - name: Compress .nx folder
      if: failure()
      run: tar -czf nx-cache.tar.gz .nx

    - name: Upload compressed .nx folder as artifact
      if: failure()
      uses: actions/upload-artifact@v3
      with:
        name: nx-cache-compressed
        path: nx-cache.tar.gz
        retention-days: 1  